<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>لوحة التحكم</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; }
    .card { max-width: 560px; margin: 0 auto; padding: 16px; border: 1px solid #ddd; border-radius: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #eee; padding: 8px; vertical-align: top; }
    th { background: #fafafa; }
    .hidden { display: none; }
    button { cursor: pointer; }
    .danger { color: #b00; }
  </style>
</head>
<body>

  <div id="loginCard" class="card">
    <h2>تسجيل الدخول (أدمن)</h2>
    <input id="email" type="email" placeholder="الإيميل" style="width:100%;margin:8px 0;padding:8px" />
    <input id="password" type="password" placeholder="الباسورد" style="width:100%;margin:8px 0;padding:8px" />
    <button id="loginBtn">دخول</button>
    <p id="loginStatus"></p>
  </div>

  <div id="dash" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>الرسائل/الطلبات</h2>
      <div>
        <select id="filterType">
          <option value="all">الكل</option>
          <option value="contact">مراسلات</option>
          <option value="order">طلبات</option>
        </select>
        <button id="logoutBtn">تسجيل الخروج</button>
      </div>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>النوع</th>
          <th>الاسم</th>
          <th>الإيميل</th>
          <th>الرسالة</th>
          <th>الوقت</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot,
      deleteDoc, doc, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // لصق نفس إعدادات مشروعك هنا
    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "XXXX",
      appId: "XXXX"
    };

    const ADMIN_EMAIL = "ahmedsalahyassen40@gmail.com"; // ← عدّل لإيميل الأدمن

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const loginCard  = document.getElementById('loginCard');
    const dash       = document.getElementById('dash');
    const emailEl    = document.getElementById('email');
    const passEl     = document.getElementById('password');
    const loginBtn   = document.getElementById('loginBtn');
    const loginMsg   = document.getElementById('loginStatus');
    const logoutBtn  = document.getElementById('logoutBtn');
    const filterType = document.getElementById('filterType');
    const tbody      = document.getElementById('tbody');

    let unsub = null; // لإلغاء الاشتراك عند اللوج آوت

    loginBtn.addEventListener('click', async () => {
      loginMsg.textContent = 'جارٍ تسجيل الدخول...';
      try {
        await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value.trim());
      } catch (e) {
        console.error(e);
        loginMsg.textContent = 'بيانات غير صحيحة.';
      }
    });

    logoutBtn.addEventListener('click', async () => {
      if (unsub) { unsub(); unsub = null; }
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      if (user && user.email === ADMIN_EMAIL) {
        // عرض اللوحة
        loginCard.classList.add('hidden');
        dash.classList.remove('hidden');

        // اشتراك لحظي في الرسائل مرتبة بالوقت
        const q = query(collection(db, 'messages'), orderBy('createdAt', 'desc'));
        if (unsub) { unsub(); }
        unsub = onSnapshot(q, (snap) => {
          const rows = [];
          snap.forEach((d) => {
            const data = d.data();
            if (filterType.value !== 'all' && data.type !== filterType.value) return;

            const created = data.createdAt instanceof Timestamp
              ? data.createdAt.toDate().toLocaleString()
              : '';

            rows.push(`
              <tr>
                <td>${data.type || ''}</td>
                <td>${(data.name || '').replaceAll('<','&lt;')}</td>
                <td>${(data.email || '').replaceAll('<','&lt;')}</td>
                <td>${(data.message || '').replaceAll('<','&lt;')}</td>
                <td>${created}</td>
                <td><button class="danger" data-id="${d.id}">حذف</button></td>
              </tr>
            `);
          });
          tbody.innerHTML = rows.join('');
        });

      } else {
        // إظهار نموذج الدخول فقط
        dash.classList.add('hidden');
        loginCard.classList.remove('hidden');
      }
    });

    // فلترة حسب النوع
    filterType.addEventListener('change', () => {
      // إعادة تريجر onSnapshot عبر تغيير unsub/إعادة الاشتراك (أسهل حل)
      auth.currentUser && onAuthStateChanged(auth, () => {});
    });

    // حذف رسالة
    tbody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-id]');
      if (!btn) return;
      if (!confirm('هل أنت متأكد من الحذف؟')) return;
      try {
        await deleteDoc(doc(db, 'messages', btn.dataset.id));
      } catch (err) {
        alert('تعذّر الحذف'); console.error(err);
      }
    });
  </script>
</body>
</html>

